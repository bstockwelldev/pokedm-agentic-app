# Docker Compose configuration for Agentic App
# Full-stack application with Express server and React client
# Development mode with hot reload support

services:
  # Express.js Backend Server
  # Environment variables are loaded from server/.env file
  # Required: AI_GATEWAY_API_KEY, LLM_MODEL (optional, defaults to openai/gpt-4o)
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: agentic-server
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-3001}:3001"
    environment:
      # Port configuration
      PORT: 3001
      # Node environment
      NODE_ENV: development
      # Docker environment flag (for service detection)
      DOCKER_ENV: "true"
      # Environment variables from .env file will be loaded by dotenv
      # Mount server/.env as volume to provide AI_GATEWAY_API_KEY, LLM_MODEL, etc.
    volumes:
      # Mount source code for hot reload
      - ./server:/app
      # Mount .env file (read-only) - ensure it exists before starting
      - ./server/.env:/app/.env:ro
      # Exclude node_modules from volume mount (use container's node_modules)
      - /app/node_modules
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - agentic-app-network

  # React + Vite Frontend Client
  # Proxies /api requests to server service
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: agentic-client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-3000}:3000"
    environment:
      # Docker environment flag (for Vite proxy configuration)
      DOCKER_ENV: "true"
      # Vite API target (optional override)
      VITE_API_TARGET: "http://server:3001"
    volumes:
      # Mount source code for hot reload
      - ./client:/app
      # Exclude node_modules from volume mount (use container's node_modules)
      - /app/node_modules
    depends_on:
      server:
        condition: service_healthy
    networks:
      - agentic-app-network

# Network configuration
# Services communicate using service names as hostnames
networks:
  agentic-app-network:
    driver: bridge
    name: agentic-app-network
